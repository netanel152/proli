# Fixi - זרימת נתונים ולוגיקה עסקית

## 1. מחזור חיי הליד (Lead Lifecycle)

כך המערכת מטפלת בליד מרגע הכניסה ועד הסגירה:

1. **New (חדש):** נוצר כאשר Gemini מזהה כוונת הזמנה (Intent) ופולט את הטוקן `[DEAL: ...]`. הליד נשמר ב-MongoDB ללא שיוך (או עם שיוך ראשוני).
2. **Booked (נקבע):** הסטטוס משתנה כאשר איש המקצוע מאשר את העבודה (דרך כפתור או פקודה). בשלב זה הליד משויך סופית לאיש המקצוע (שדה `pro_id`).
3. **Completed (הושלם):** איש המקצוע או הלקוח מאשרים שהעבודה הסתיימה.
4. **Waiting for Rating:** סטטוס ביניים הממתין לדירוג (1-5) מהלקוח.
5. **Rated:** לאחר שהלקוח מדרג, הציון משוקלל בפרופיל איש המקצוע והליד נסגר סופית.

## 2. מוח ה-AI (קבצים: `ai_engine.py`, `workflow.py`)

המערכת משתמשת ב-Gemini 2.5 Flash Lite דרך המחלקה `AIEngine`.

- **שיחה שוטפת:** ההיסטוריה נשלחת ל-Gemini בכל הודעה.
- **זיהוי עסקה:** ה-Prompt המערכתי מונחה לזהות פרטי מיקום וזמן ולפלוט תגית `[DEAL:...]` מובנית.
- **ניתוב (Routing):** מתבצע ברמת ה-`Workflow` (עתידי: ה-AI ינתח ויחליט למי להעביר). כרגע משתמשים בלוגיקה היברידית או שיוך ידני בדמו.

## 3. תהליך התזמון (`scheduler.py`)

- רץ ברקע כל 60 שניות.
- בודק ב-MongoDB (`settings_collection`) אם הגיע הזמן לשלוח תזכורות (ברירת מחדל: 08:00).
- שולח לכל איש מקצוע רשימה מרוכזת של הלידים בסטטוס `Booked` לאותו יום דרך `WhatsAppClient`.
- **ניטור עבודות תקועות:** בודק לידים שנפתחו לפני זמן רב ולא נסגרו, ושולח תזכורות יזומות (כפתורים) לאיש המקצוע וללקוח.