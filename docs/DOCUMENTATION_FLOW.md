# Fixi - זרימת נתונים ולוגיקה עסקית

## 1. מחזור חיי הליד (Lead Lifecycle)

כך המערכת מטפלת בליד מרגע הכניסה ועד הסגירה:

1. **Contacted (נוצר קשר):** שלב ראשוני. ה-AI מזהה עיר/בעיה ויוצר רשומה זמנית, עוד לפני שיוך סופי לאיש מקצוע.
2. **New (חדש/ממתין לאישור):** הליד שויך לאיש מקצוע ספציפי (לאחר זיהוי [DEAL] או פרטים מלאים) ונשלחה אליו הודעה לאישור ('אשר'/'דחה').
3. **Booked (נקבע):** הסטטוס משתנה כאשר איש המקצוע מאשר את העבודה.
    *   המערכת מבצעת **נעילת חלון זמן (Slot Booking)** ביומן באופן אטומי.
    *   הליד "נעול" לאיש המקצוע.
4. **Completed (הושלם):** איש המקצוע או הלקוח מאשרים שהעבודה הסתיימה (באמצעות כפתורים אינטראקטיביים או טקסט).
5. **Waiting for Rating:** סטטוס ביניים הממתין לדירוג (1-5) מהלקוח.
6. **Rated:** לאחר שהלקוח מדרג, הציון משוקלל בפרופיל איש המקצוע והליד נסגר סופית.
7. **Rejected (נדחה):** איש המקצוע דחה את הליד (המערכת יכולה לנסות לנתב מחדש - לוגיקה עתידית).

## 2. מוח ה-AI (קבצים: `ai_engine.py`, `workflow.py`)

המערכת משתמשת ב-Gemini 2.5 Flash Lite בתהליך דו-שלבי:

1.  **Dispatcher (סדרן):**
    *   מנתח את הודעת המשתמש (טקסט/מדיה).
    *   מחלץ `City` ו-`Issue`.
    *   מחפש את איש המקצוע המתאים ביותר (Matching Service).

2.  **Pro Persona (פרסונה):**
    *   אם נמצא איש מקצוע, ה-AI מקבל את ה-System Prompt הייחודי שלו (טון, מחירים, כללים).
    *   מנהל את השיחה מול הלקוח כאילו הוא איש המקצוע.
    *   כאשר כל הפרטים סגורים, פולט תגית `[DEAL:...]` או JSON מובנה.

## 3. תהליך התזמון (רץ ב-Worker)

ה-`Scheduler` (קובץ `app/scheduler.py`) מנוהל כעת על ידי תהליך ה-**Worker** (`app/worker.py`), ולא על ידי ה-API.

- **Daily Reminders (כל 60 שניות):**
    - בודק ב-MongoDB (`settings_collection`) אם הגיע הזמן לשלוח תזכורות (ברירת מחדל: 08:00).
    - שולח לכל איש מקצוע רשימה מרוכזת של הלידים בסטטוס `Booked` לאותו יום דרך `WhatsAppClient`.

- **Stale Job Monitor (כל 30 דקות):**
    - **ניטור עבודות תקועות:** בודק לידים שנפתחו לפני זמן רב ולא נסגרו, ושולח תזכורות יזומות (כפתורים) לאיש המקצוע וללקוח.

- **SOS Recovery (כל 10 דקות):**
    - מפעיל את `check_and_reassign_stale_leads` כדי לנתב מחדש לידים שלא טופלו בזמן.

- **SOS Admin Reporter (כל 4 שעות):**
    - שולח דו"ח מרוכז למנהל המערכת על לידים שעדיין תקועים לאחר ניסיונות התיקון.

## 4. מנגנון SOS Recovery (קובץ: `monitor_service.py`)

המערכת מבטיחה רציפות שירות גם כאשר אנשי המקצוע אינם זמינים:

1.  **זיהוי סטגנציה:** ה-Scheduler מפעיל את `check_and_reassign_stale_leads`.
2.  **ניתוב מחדש:** אם ליד ממתין מעבר לזמן המוגדר, המערכת מחפשת איש מקצוע אחר המתאים לאותה עיר ותחום.
3.  **עדכון סטטוס:** הליד מעודכן עם איש המקצוע החדש, ה-Timer מתאפס, ונשלחות הודעות עדכון לכל הצדדים.
4.  **אסקלציה:** אם לא נמצא מחליף, הליד נכלל בדו"ח המנהל שנשלח מדי 4 שעות.