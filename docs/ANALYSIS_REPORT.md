# דו"ח ניתוח קוד - Proli

## סקירה כללית
הפרויקט **Proli** בנוי בצורה מרשימה, תוך שימוש בטכנולוגיות מודרניות וחזקות (FastAPI, Streamlit, MongoDB, Redis, ARQ). הארכיטקטורה הכללית נכונה ומפרידה בין שכבות האחריות בצורה טובה ברוב המקרים.

עם זאת, במהלך הסקירה זוהו מספר נקודות קריטיות לשיפור בארכיטקטורה, בטיחות הקוד, ותחזוקתיות לטווח ארוך. להלן הממצאים המפורטים.

---

## 🛠️ המלצות לשיפור קריטי (Critical)

### 1. Refactoring ל-`workflow_service.py` ("God Object")
הקובץ `app/services/workflow_service.py`, ובפרט הפונקציה `process_incoming_message`, הפך ל-"God Object".
- **הבעיה:** הפונקציה מטפלת בהכל בו-זמנית: בדיקת פקודות מערכת ("reset"), לוגיקה של ניהול מדינה (State), הורדה ועיבוד מדיה, ניתוח טקסט, קריאה ל-AI, וניתוב לבעלי מקצוע.
- **הסיכון:** קוד כזה קשה מאוד לבדיקה (Testing), מועד לבאגים, וקשה להוספת פיצ'רים חדשים.
- **המלצה:** יש לפצל את הלוגיקה לשירותים ייעודיים:
    - `MessageProcessorService`: לניהול זרימת ההודעה.
    - `MediaService`: לטיפול בהורדה וזיהוי סוגי מדיה.
    - `ProCommandService`: לטיפול בפקודות טקסטואליות של בעלי מקצוע (אשר/דחה/סיימתי).

### 2. הפרדת רשויות ב-Admin Panel
הקובץ `admin_panel/views/home.py` מכיל לוגיקה עסקית וגישה ישירה למסד הנתונים (`leads_collection.update_one`).
- **הבעיה:** שכבת התצוגה (View) לא אמורה להכיר את מבנה המסד או לבצע שינויים ישירות.
- **הסיכון:** שינוי במבנה ה-DB ידרוש שינוי בקבצי ה-UI, ואין שימוש חוזר בלוגיקה (למשל, ולידציות).
- **המלצה:** להעביר את כל פעולות העדכון ל-`LeadManager` או ל-`AdminService` חדש. ה-View צריך רק לקרוא לפונקציה `update_lead(...)`.

### 3. טיפול בשגיאות (Error Handling)
נמצאו מספר מקומות בהם שגיאות נתפסות (`try...except`) אך רק נרשמות ללוג ללא טיפול אמיתי ("Swallowing Exceptions").
- **דוגמה:** ב-`whatsapp_client_service.py`, אם שליחת הודעה נכשלת, השגיאה מודפסת אך לעיתים הזרימה ממשיכה כאילו הכל כשורה, או שה-Retry של `tenacity` לא מופעל כראוי אם השגיאה נבלעת.
- **המלצה:** יש לוודא ששגיאות קריטיות נזרקות מחדש (Re-raise) כדי שמנגנוני ה-Retry או הדיווח למשתמש יפעלו.

---

## 🎨 איכות קוד (Code Quality)

1.  **Hardcoded Strings:** למרות קיום הקובץ `messages.py`, עדיין קיימות מחרוזות בקוד כגון `"reset"`, `"menu"`, `"תפריט"`. יש להעביר את כולן לקובץ קבועים מסודר.
2.  **Type Hinting:** השימוש ב-Type Hints טוב ברוב המקומות, אך חסר בחלק מהפונקציות המרכזיות (למשל החזרת `None` מרומזת).
3.  **ניהול מדיה (Media Handling):**
    - כרגע `workflow_service` מנסה להוריד תמונות, אך מעביר URLs של וידאו/אודיו ל-AI.
    - הלוגיקה ב-`ai_engine_service` שמורידה קבצים לקובץ זמני (`tempfile`) היא נכונה, אך מעורבבת בתוך הלוגיקה של ה-AI. כדאי להוציא אותה לפונקציית עזר חיצונית.

---

## ✨ פיצ'רים מומלצים להוספה

1.  **אימות Webhook:**
    - ב-`webhook.py` יש בדיקה של `idInstance`, אך מומלץ להוסיף אימות חזק יותר אם ה-API מאפשר זאת (למשל בדיקת IP או חתימה דיגיטלית), כדי למנוע בקשות זדוניות.
2.  **בדיקות (Testing):**
    - יש להוסיף בדיקות יחידה (Unit Tests) ספציפיות ל-`Media Handling` החדש ב-`ai_engine_service` (עם Mock ל-httpx ו-files API) כדי לוודא שלא נוצרות דליפות זיכרון או קבצים זמניים שנשארים בדיסק.
3.  **אבטחה ב-Admin:**
    - מנגנון ההתחברות הנוכחי הוא בסיסי (Cookie). מומלץ לשקול מעבר ל-JWT או אימות מבוסס Session חזק יותר עם Expiration מנוהל היטב בצד השרת (Redis).

## סיכום
הפרויקט נמצא במצב טוב מאוד מבחינת בשלות ופיצ'רים. ביצוע ה-Refactoring המוצע ב-`workflow_service` וב-Admin Panel ישפר משמעותית את היציבות ויקל על הוספת יכולות חדשות בעתיד.
