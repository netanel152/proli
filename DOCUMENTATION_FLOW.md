# Fixi - זרימת נתונים ולוגיקה עסקית

## 1. מחזור חיי הליד (Lead Lifecycle)

כך המערכת מטפלת בליד מרגע הכניסה ועד הסגירה:

1. **New (חדש):** נוצר כאשר Gemini מזהה כוונת הזמנה (Intent) ופולט את הטוקן `[DEAL: ...]`. הליד נשמר ב-MongoDB ללא שיוך (או עם שיוך ראשוני).
2. **Booked (נקבע):** הסטטוס משתנה אוטומטית כאשר איש מקצוע שולח את הפקודה `GET_WORK`. בשלב זה הליד משויך סופית לאיש המקצוע (שדה `pro_id`).
3. **Completed (הושלם):** איש המקצוע שולח פקודה `FINISH_JOB`. המערכת שולחת הודעת סיכום ללקוח ומבקשת דירוג.
4. **Waiting for Rating:** סטטוס ביניים הממתין למספר (1-5) מהלקוח.
5. **Rated:** לאחר שהלקוח מדרג, הציון משוקלל בפרופיל איש המקצוע והליד נסגר סופית.

## 2. מוח ה-AI (קבצים: `logic.py`, `seed_db.py`)

המערכת משתמשת ב-Gemini 2.0 Flash Lite עם הנחיות (System Prompts) דינמיות:

- **ניתוב (Routing):** המערכת סורקת את הטקסט. אם מזוהה שם של עיר שמופיעה ב-`service_areas` של איש מקצוע פעיל - השיחה מנותבת אליו.
- **פקודות (Commands):** המערכת מזהה פקודות מיוחדות מאנשי המקצוע בלבד:
  - `GET_WORK`: משיכת הליד הישן ביותר בסטטוס New.
  - `BLOCK [שעה]`: חסימת סלוט ביומן.
  - `VACATION`: חסימת יום שלם.
- **מדיניות מחירים:** הבוט מונחה (דרך `seed_db.py`) לא לתת מחיר סופי בטלפון, אלא לציין עלות ביקור ולקזז אותה במידה ויש תיקון.

## 3. תהליך התזמון (`scheduler.py`)

- רץ ברקע כל 60 שניות.
- בודק ב-MongoDB (`settings_collection`) אם הגיע הזמן לשלוח תזכורות (ברירת מחדל: 08:00).
- שולח לכל איש מקצוע רשימה מרוכזת של הלידים בסטטוס `Booked` לאותו יום.
