# מדריך תפעול ותקלות - Fixi

## ארכיטקטורת ריצה

המערכת רצה בשני תהליכים נפרדים (Processes):

1. **שרת ה-Backend (`uvicorn`):** אחראי על קבלת Webhooks, הרצת מנוע הניתוב (Routing Engine), וניהול התקשורת עם Gemini.
2. **ממשק הניהול (`streamlit`):** דשבורד ויזואלי למנהל המערכת.

## ניהול שוטף (Dashboard)

### יצירת ליד חדש (Create Lead)
לשונית חדשה בלוח הבקרה מאפשרת יצירה ידנית של לידים:
1. עבור לטאב **"Create New Lead"**.
2. הזן מספר טלפון (חובה - משמש כמזהה ייחודי).
3. בחר איש מקצוע משויך (אופציונלי).
4. הזן פרטי תקלה וסטטוס התחלתי.
5. לחץ **"Create Lead"**. הליד יופיע מיד בטבלה הראשית.

### עריכת לידים
ניתן לערוך פרטים ישירות בטבלה (Data Editor):
*   **Status:** שינוי סטטוס הטיפול.
*   **Professional:** שינוי השיוך לאיש מקצוע (ניתן להעביר ליד מאחד לשני).
*   **Issue/Details:** עדכון תיאור התקלה.
*   **שמירה:** יש ללחוץ על **"Save Changes"** כדי לשמור את השינויים ב-DB.

## פתרון תקלות נפוצות

### 1. הבוט עונה כ-"Fixi Support" (ברירת מחדל)
זה קורה כאשר מנוע הניתוב לא מוצא איש מקצוע מתאים.
*   **בדיקה:** האם יש אנשי מקצוע עם `is_active: True` ב-DB?
*   **בדיקה:** האם הלקוח ציין עיר שלא נמצאת ב-`service_areas` של אף אחד?
*   **פתרון:** הוסף אזורי שירות או הפעל אנשי מקצוע דרך מסך "Professionals".

### 2. הבוט לא מגיב לתמונות/הודעות קוליות
*   **בדיקה:** האם `httpx` מותקן? (נסה `pip install httpx`).
*   **בדיקה:** האם הקובץ נגיש ציבורית (URL תקין)?
*   **לוגים:** חפש שגיאות `Error downloading media` בלוג.

### 3. הלידים לא מופיעים בדשבורד
*   נסה ללחוץ על כפתור "Refresh Leads".
*   וודא שאתה מחובר ל-Database הנכון.

## ניהול גרסאות ושחזור

- **הוספת איש מקצוע:** דרך האדמין או `python scripts/seed_db.py`.
- **ניקוי נתונים:** `python scripts/clear_history.py` (זהירות!).

## אבטחה ומקביליות (Database Safety)

### מנגנון הנעילה של ה-Scheduler
כדי למנוע שליחת הודעות כפולות (Race Conditions) כאשר רצים מספר תהליכים:
- ה-Scheduler משתמש בפקודה `find_one_and_update` של MongoDB.
- פעולה זו היא **אטומית** (Atomic): היא בודקת ונועלת את הריצה בפעולה אחת.
- הלוגיקה נמצאת ב-`app.scheduler.scheduler_manager`.

### אבטחת Admin Panel
- הסיסמאות לא נשמרות כטקסט גלוי.
- המערכת משתמשת ב-**Bcrypt** עם Salt לייצור Hash.
- האימות מול הדפדפן מתבצע באמצעות Cookie מאובטח (`fixi_auth_token`).