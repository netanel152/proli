# מדריך תפעול ותקלות - Fixi

## ארכיטקטורת ריצה

המערכת יכולה לרוץ בשני אופנים:

**אפשרות א' (מומלץ): Docker Containers**
*   **Web (Backend):** קונטיינר המריץ את `uvicorn`.
*   **Admin:** קונטיינר המריץ את `streamlit`.
*   שניהם מנוהלים דרך `docker-compose.yml` ומשתפים רשת פנימית.

**אפשרות ב': ריצה מקומית (Local)**
1. **שרת ה-Backend (`uvicorn`):** אחראי על קבלת Webhooks, הרצת מנוע הניתוב (Routing Engine), וניהול התקשורת עם Gemini.
2. **ממשק הניהול (`streamlit`):** דשבורד ויזואלי למנהל המערכת.

## ניהול וניטור (Logs & Monitoring)

### צפייה בלוגים (Docker)
המערכת משתמשת ב-`Loguru` לניהול לוגים מובנה.
```bash
# צפייה בלוגים של כל השירותים בזמן אמת
docker-compose logs -f

# צפייה בלוגים של שירות ספציפי
docker-compose logs -f web    # Backend
docker-compose logs -f admin  # Admin Panel
```

### קבצי לוג (Local/Archive)
הלוגים נשמרים גם לקבצים בתיקיית `logs/`:
*   `fixi.log`: לוג ראשי (מתגלגל כל 10MB).
*   הלוגים נשמרים למשך 10 ימים ונדחסים אוטומטית.

## ניהול שוטף (Dashboard)

### יצירת ליד חדש (Create Lead)
לשונית חדשה בלוח הבקרה מאפשרת יצירה ידנית של לידים:
1. עבור לטאב **"Create New Lead"**.
2. הזן מספר טלפון (חובה - משמש כמזהה ייחודי).
3. בחר איש מקצוע משויך (אופציונלי).
4. הזן פרטי תקלה וסטטוס התחלתי.
5. לחץ **"Create Lead"**. הליד יופיע מיד בטבלה הראשית.

### עריכת לידים
ניתן לערוך פרטים ישירות בטבלה (Data Editor):
*   **Status:** שינוי סטטוס הטיפול.
*   **Professional:** שינוי השיוך לאיש מקצוע (ניתן להעביר ליד מאחד לשני).
*   **Issue/Details:** עדכון תיאור התקלה.
*   **שמירה:** יש ללחוץ על **"Save Changes"** כדי לשמור את השינויים ב-DB.

## פתרון תקלות נפוצות

### 1. הבוט עונה כ-"Fixi Support" (ברירת מחדל)
זה קורה כאשר מנוע הניתוב לא מוצא איש מקצוע מתאים.
*   **בדיקה:** האם יש אנשי מקצוע עם `is_active: True` ב-DB?
*   **בדיקה:** האם הלקוח ציין עיר שלא נמצאת ב-`service_areas` של אף אחד?
*   **פתרון:** הוסף אזורי שירות או הפעל אנשי מקצוע דרך מסך "Professionals".

### 2. הבוט לא מגיב לתמונות/סרטונים/הודעות קוליות
*   **בדיקה:** האם `httpx` מותקן? (נסה `pip install httpx`).
*   **בדיקה:** האם הקובץ נגיש ציבורית (URL תקין)?
*   **לוגים:** חפש שגיאות `Error downloading media` בלוג.

### 3. הלידים לא מופיעים בדשבורד
*   נסה ללחוץ על כפתור "Refresh Leads".
*   וודא שאתה מחובר ל-Database הנכון.

### 4. ניטור ביצועי AI (Fallback Monitoring)
המערכת מנסה באופן אוטומטי לעבור מודלים במקרה של כשל.
*   **לוגים:** חפש `Model ... failed` בלוגים כדי לראות אם המערכת נאלצה לעבור למודל גיבוי.
*   **כשל מוחלט:** אם כל המודלים נכשלים, תופיע שגיאה `All AI models failed`. בדוק את ה-API Key ואת המכסות (Quota) בגוגל.

## ניהול גרסאות ושחזור

- **הוספת איש מקצוע:** דרך האדמין או `python scripts/seed_db.py`.
- **ניקוי נתונים:** `python scripts/clear_history.py` (זהירות!).

## אבטחה ומקביליות (Database Safety)

### מנגנון הנעילה של ה-Scheduler
כדי למנוע שליחת הודעות כפולות (Race Conditions) כאשר רצים מספר תהליכים:
- ה-Scheduler משתמש בפקודה `find_one_and_update` של MongoDB.
- פעולה זו היא **אטומית** (Atomic): היא בודקת ונועלת את הריצה בפעולה אחת.
- הלוגיקה נמצאת ב-`app.scheduler.scheduler_manager`.

### Slot Booking Safety (נעילת תורים)
בדומה ל-Scheduler, גם קביעת התורים ביומן משתמשת במנגנון אטומי למניעת כפילויות (Double Booking):
- הפונקציה `book_slot_for_lead` משתמשת ב-`find_one_and_update` על קולקציית `slots`.
- היא מחפשת חלון זמן פנוי (`is_taken: False`) ונועלת אותו (`is_taken: True`) בפעולה אחת.
- זה מבטיח שגם אם שני לידים מנסים לתפוס את אותו תור באותה מילי-שנייה, רק אחד יצליח.

### אבטחת Admin Panel
- הסיסמאות לא נשמרות כטקסט גלוי.
- המערכת משתמשת ב-**Bcrypt** עם Salt לייצור Hash.
- האימות מול הדפדפן מתבצע באמצעות Cookie מאובטח (`fixi_auth_token`).